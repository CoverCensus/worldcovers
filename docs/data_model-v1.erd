erDiagram
    %% =========================
    %% CORE REFERENCE TABLES
    %% =========================
    TBLSTATES {
        int    nStateID PK
        string txtState
        string txtStateAbv
        string txtFilename
        string txtPDF
        int    nMarkings
        bool   ynCompleted
    }

    TBLABBREVIATIONS {
        int    ID PK
        string txtAbbreviation
        string txtMeaning
        int    nOrder
        bool   ynActive
    }

    TBLTOWNMARKLETTERING {
        int    nTownmarkLetteringID PK
        string txtTownmarkLettering
        string memTownmarkLettering
        int    nOrder
        bool   ynActive
    }

    TBLTOWNMARKFRAMING {
        int    nTownmarkFramingID PK
        string txtTownmarkFraming
        string memTownmarkFraming
        int    nOrder
        bool   ynActive
    }

    TBLTOWNMARKDATEFORMAT {
        int    nTownmarkDateFormatID PK
        string txtTownmarkDateFormat
        string memTownmarkDateFormat
        int    nOrder
        bool   ynActive
    }

    TBLTOWNMARKRATELOCATION {
        int    nTownmarkRateLocationID PK
        string txtTownmarkRateLocation
        string memTownmarkRateLocation
        int    nOrder
        bool   ynActive
    }

    TBLTOWNMARKRATEVALUE {
        int    nTownmarkRateValueID PK
        float  txtTownmarkRateValue
        int    nOrder
        bool   ynActive
    }

    %% =========================
    %% RAW MARKING DATA
    %% =========================
    TBLRAWSTATEDATA {
        int    nRawStateDataID PK
        int    nRawStateDataID_parent FK   "self-grouping"
        int    nGroupOrder
        int    nStateID FK
        string txtPublishedID               "ASCC ID / listing key"
        string txtRawStateData
        string txtPostmark
        string txtDatesSeen
        string txtSizes
        string txtColors
        string txtRates
        string txtRatesText
        string txtValue
        string txtTerritory
        string txtTown
        string txtTownmarkShape
        string txtTownmarkLettering
        string txtTownmarkDateFormat
        string txtTownmarkFraming
        string txtTownmarkRateLocation
        string txtTownmarkRateText
        string txtTownmarkRateValue
        string txtTownmarkColor
        bool   ynManuscriptTownmarks
        int    nImageCount
        int    submitterId      "external User"
        int    approverId       "external User"
        string approve_status
        string request_status
    }

    TBLRAWSTATEDATA_PENDINGUPDATE {
        int    id PK
        int    nRawStateDataID FK
        int    nRawStateDataID_parent
        int    nGroupOrder
        int    nStateID FK
        string txtPublishedID
        string txtRawStateData
        string txtPostmark
        string txtDatesSeen
        string txtSizes
        string txtColors
        string txtRates
        string txtRatesText
        string txtValue
        string txtTerritory
        string txtTown
        string txtTownmarkShape
        string txtTownmarkLettering
        string txtTownmarkDateFormat
        string txtTownmarkFraming
        string txtTownmarkRateLocation
        string txtTownmarkRateText
        string txtTownmarkRateValue
        string txtTownmarkColor
        bool   ynManuscriptTownmarks
        int    nImageCount
        bool   ynForReview
        string approve_status
        string request_status
        string txtUserEmail
    }

    TBLTOWNMARKIMAGES {
        int    nTownmarkImageID PK
        int    nRawStateDataID FK
        string txtFilename
        string txtView
        int    nX
        int    nY
        int    nWidth
        int    nHeight
        string imageStatus
        string submitterName
        string submitterEmail
        bool   ynEmailCheck
    }

    %% =========================
    %% PROCESS / PERMISSIONS
    %% =========================
    TBLPARSESTEPS {
        int    nParseStepID PK
        string txtParseStep
        int    nStateID FK
        bool   ynCompleted
        int    nOrder
        bool   ynActive
    }

    CTUSERSTATES {
        int    ID PK
        int    nUserID            "external User"
        int    nStateID FK
        string memRoles
    }

    %% =========================
    %% COVERS (USER-ENTERED)
    %% =========================
    TBLCOVERS {
        int    nCoverID PK
        int    nUserID            "external User"
        string txtCoverKeyID
        string txtStateAbv
        string txtTerritory
        string txtTown
        string txtTownmarkShape
        string txtLettering
        string txtTownmarkFraming
        string txtDateFormat
        string txtRate
        string txtRateText
        string txtSecondRate
        float  nWidth
        float  nHeight
        string txtColor
        int    nEarliestUseDay
        int    nEarliestUseMonth
        int    nEarliestUseYear
        int    nLatestUseDay
        int    nLatestUseMonth
        int    nLatestUseYear
        string memASCCText
        string memNotes
        string memOtherChar
        float  nEstimatedValue
        string txtPublishedID     "links to raw ASCC row"
        string txtImage1
        string txtImage2
    }

    %% =========================
    %% RELATIONSHIPS
    %% =========================

    %% State-scoped data
    TBLSTATES ||--o{ TBLRAWSTATEDATA             : "has markings for"
    TBLSTATES ||--o{ TBLRAWSTATEDATA_PENDINGUPDATE : "has pending edits"
    TBLSTATES ||--o{ TBLPARSESTEPS              : "has parse steps"
    TBLSTATES ||--o{ CTUSERSTATES               : "visible-to"

    %% Raw-state-data graph
    TBLRAWSTATEDATA ||--o{ TBLRAWSTATEDATA       : "parent/child group"
    TBLRAWSTATEDATA ||--o{ TBLTOWNMARKIMAGES     : "has images"
    TBLRAWSTATEDATA ||--o{ TBLRAWSTATEDATA_PENDINGUPDATE : "edit proposals"

    %% Covers ↔ ASCC entries (via PublishedID, StateAbv)
    TBLSTATES ||--o{ TBLCOVERS                   : "covers in state"
    TBLRAWSTATEDATA ||..o{ TBLCOVERS             : "same txtPublishedID"

    %% User–state mapping (User entity is external to this CSV set)
    CTUSERSTATES }o--|| TBLSTATES                : "state scope"

    %% Lookup / classification tables (logical links via text codes)
    TBLABBREVIATIONS ||..o{ TBLRAWSTATEDATA      : "parses abbrevs"
    TBLTOWNMARKLETTERING ||..o{ TBLRAWSTATEDATA  : "lettering values"
    TBLTOWNMARKFRAMING ||..o{ TBLRAWSTATEDATA    : "framing values"
    TBLTOWNMARKDATEFORMAT ||..o{ TBLRAWSTATEDATA : "date formats"
    TBLTOWNMARKRATELOCATION ||..o{ TBLRAWSTATEDATA : "rate locations"
    TBLTOWNMARKRATEVALUE ||..o{ TBLRAWSTATEDATA  : "rate values"
